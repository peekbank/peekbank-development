---
title: "Subject-level developmental relationships"
format: html
---

```{r}
library(here)
source(here("helper","common.R"))
d_sub <- readRDS(here("cached_intermediates","1_d_sub"))
load(here("..", "peekbank-method", "cached_intermediates", "1_cdi_subjects.Rds"))
```


This is broken due to some repeated fields. 

```{r}
d_cdi <- cdi_data |>
  select(administration_id, native_language, measure, language, 
         rawscore) |>
  filter(language == "English (American)", native_language == "eng") |>
  pivot_wider(names_from = "measure", values_from = "rawscore", 
              values_fill = NA, values_fn = mean)
```


```{r}
d_sub_cdi <- d_sub |>
  left_join(d_cdi) |>
  mutate(log_age = log(age)) |>
  ungroup()
```


# Relation between RT and accuracy 

Take a look at correlations to select variables. 

```{r}
GGally::ggpairs(select(d_sub_cdi, age, log_age, rt, log_rt, 
                       short_window_accuracy, long_window_accuracy, 
                       short_window_elogit, long_window_elogit, prod, comp), 
        progress = FALSE, lower = list(continuous = GGally::wrap("points", alpha = 0.03)))

```

Let's select the best of these. 

```{r}
GGally::ggpairs(select(d_sub_cdi, log_age, rt,  
                       long_window_accuracy, prod, comp), 
        progress = FALSE, lower = list(continuous = GGally::wrap("points", alpha = 0.03)))

```

<!-- So these are somewhat related to one another. Let's take a deeper look.  -->

<!-- ```{r} -->
<!-- ggplot(acc_rt, aes(x = log_rt, y = elogit, col = log_age)) + -->
<!--   geom_point(alpha = .3) + -->
<!--   geom_smooth(method = "lm") + -->
<!--   geom_hline(yintercept = .5, lty = 2) +  -->
<!--   xlab("Mean log RT") +  -->
<!--   ylab("Mean elogit(accuracy)") -->
<!-- ``` -->

<!-- Broken out by age group.  -->

<!-- ```{r} -->
<!-- ggplot(acc_rt, aes(x = log_rt, y = elogit)) + -->
<!--   geom_point(alpha = .3) + -->
<!--   geom_smooth(method = "lm") + -->
<!--   geom_hline(yintercept = .5, lty = 2) + -->
<!--   facet_wrap(~age_group_years) +  -->
<!--   xlab("Mean log RT") +  -->
<!--   ylab("Mean elogit accuracy") -->


<!-- ``` -->

<!-- By dataset.  -->

<!-- ```{r} -->
<!-- ggplot(acc_rt, aes(x = log_rt, y = elogit, col = log_age)) + -->
<!--   geom_point(alpha = .3) + -->
<!--   geom_smooth(method = "lm") + -->
<!--   geom_hline(yintercept = .5, lty = 2) + -->
<!--   facet_wrap(~dataset_name) +  -->
<!--   xlab("Mean log RT") +  -->
<!--   ylab("Mean elogit accuracy") -->

<!-- ``` -->

## Dimensionality reduction

Let's do principal components analysis over the scaled variables. 

```{r}
d_sub_cdi_mat <- d_sub_cdi |>
  ungroup() |>
  select(log_age, rt,  long_window_accuracy, prod) |>
  mutate(log_age = scale(log_age)[,1], 
         rt = scale(rt)[,1],
         long_window_accuracy = scale(long_window_accuracy)[,1], 
         prod = scale(prod)[,1])

d_sub_cdi_mat <- d_sub_cdi_mat |>
  filter(complete.cases(d_sub_cdi_mat)) |>
  as.matrix() 

acc_rt_prc <- prcomp(d_sub_cdi_mat, 2)

acc_rt_prc
summary(acc_rt_prc)
ggbiplot::ggbiplot(acc_rt_prc, alpha = .1)


```

We see that there is a first component with ~60% of variance that is "faster, more accurate, older". Then we see a second component that relates to younger, faster, slightly less accurate. And the final piece is older and less accurate.

These would be interesting components to connect to CDI. In some sense, the claim of some of the Fernald processing corpus is that there is a second principal component here (namely, processing speed) that is meaningful and relates to later learning outcomes. 

# Conclusions

Probably right now we need to try and connect this to CDIs...

